# 项目技术架构（HumAInity）

## 技术栈概览
- **框架**：Next.js 16（React 19，App Router，`use client` 组件为主）
- **3D/渲染**：`@react-three/fiber` + `three`，辅以 `@react-three/drei` 工具组件
- **状态管理**：`zustand`（轻量全局状态，集中于游戏状态）
- **样式**：Tailwind CSS 4（`globals.css` 定义基础变量）
- **测试**：Vitest + React Testing Library（`vitest` 脚本）

## 目录结构与职责
- `app/page.tsx`：入口页面。启动页收集领袖名称；进入 3D 场景后承载 `GameScene`。
- `app/layout.tsx`：全局布局与字体加载。
- `app/globals.css`：全局样式与主题变量。
- `app/components/Game/`
  - `GameState.ts`：`zustand` 状态（资源、日志、交互状态、待处理指令）及操作函数。
  - `GameScene.tsx`：3D 主场景（Canvas）；包含地形、水体、资源生成、玩家/智能体行为、近场检测与指令执行。
  - `GameUI.tsx`：覆盖式 UI（资源面板、日志窗口、对话输入区），调用 `GameState` 读写状态和指令。
- `app/components/World/ResourceTile.tsx`：资源单元（树/石头）模型与 hover 效果。
- `public/`：静态资源。

## 核心运行流程
1) **启动页**：用户输入文明代号并启动 -> 切换到 3D 场景。
2) **场景渲染（`GameScene`）**：
   - 创建等轴测相机、光照、地形/水体占位。
   - 随机生成资源节点（树/石）。
   - 挂载角色：
     - `PlayerLeader`：WASD 控制（基于相机朝向），头顶名称标签，边界限定。
     - `WorkerAgent`（德米特里）：状态机 `IDLE/LISTENING/THINKING/ACTING/ASKING`，近场自动聆听，执行“砍树”指令并更新木材、日志、资源删除。
   - 近场检测：玩家与 NPC 距离 < 3 进入 LISTENING；远离回退 IDLE。
   - 指令流：
     - UI 将输入写入 `pendingCommand`。
     - 场景 effect 监听：若近场且 LISTENING 且包含“砍树/伐木” -> 询问数量（ASKING）；解析数字后进入 ACTING。
     - 执行砍树：移动到目标树，挥动并删除最近树 -> `addWood(+1)`，记录日志；队列耗尽后回到 LISTENING/IDLE。
3) **UI 层（`GameUI`）**：
   - 资源面板：显示木材。
   - 日志：系统/聊天两类；可展开。
   - 对话输入：近场时提示“正在与德米特里交谈...”；发送后将内容写入 `pendingCommand`，等待场景处理。

## 状态与数据
- `wood`：当前木材数量。
- `logs`：日志队列（保留最近 200 条）。
- `isNearAgent`：是否处于近场。
- `inputFocused`：输入框聚焦时屏蔽 WASD 移动。
- `agentState`：NPC 状态机。
- `pendingCommand`：待解析的玩家指令（字符串）。

## 测试策略
- 工具：Vitest（jsdom 环境）+ React Testing Library + jest-dom，见 `vitest.config.ts` / `vitest.setup.ts`。
- 命令：`npm test`
- 测试用例（`__tests__/`）：
  - **单元测试**：
    - `GameState.test.ts`：验证资源累加、日志记录等状态管理逻辑。
    - `GameUI.test.tsx`：验证 UI 组件基本行为（近场占位提示、发送消息等）。
  - **集成测试**：
    - `ChopTreeFlow.test.ts`：完整的砍树指令流程测试，包括状态变化、指令解析、资源更新。
    - `ChatDisplay.test.tsx`：对话显示逻辑测试，验证消息过滤、聚焦/非聚焦显示、玩家消息立即显示等。
- 编写约定：新增/修改功能时，同步补充或更新对应模块测试；如牵涉 3D 交互，优先在状态与纯逻辑层（store/纯函数）添加覆盖，再视需要对 UI 进行行为测试。

## 关键实现细节

### 砍树指令执行流程（v1.1 修复）
1. **指令接收**：玩家在近场（<3 距离）向德米特里发送"砍树"指令。
2. **数量询问**：德米特里进入 `ASKING` 状态，询问数量。
3. **目标选择**：解析数量后，立即在周围找最近的树，设置 `actionTarget` 坐标。
4. **执行动作**：进入 `ACTING` 状态，德米特里移动到目标位置并挥动砍伐。
5. **队列处理**：完成一棵后，若队列未空，重新寻找最近树并设置新 `actionTarget`；若队列清空或无树可砍，延迟 100ms 检测玩家距离，返回 `LISTENING`（近场）或 `IDLE`（远场）。

**修复要点（2025-12-09 v1.1）**：
- 问题：原实现在解析数量后直接设置 `ACTING` 状态，但未设置 `actionTarget`，导致德米特里无法移动和执行任务，玩家也因此无法恢复近场监听。
- 解决：在进入 `ACTING` 前/时，从 `resources` 中计算最近树并设置坐标；在 `onActionDone` 中，每次砍完一棵后重新查找下一棵并更新 `actionTarget`；任务完成后，延迟检测实时距离以决定最终状态。

**修复要点（2025-12-09 v1.2）**：
- 问题 1：正则表达式 `/\\d+/` 写错（双反斜杠），导致无法解析数字，德米特里一直询问数量。
- 问题 2：相机拉高后地面扭曲，正交相机缺少 `near` 和 `far` 参数。
- 问题 3：山体疯狂闪烁，`Mountain` 组件每帧重新生成随机值。
- 解决：
  - 修正正则为 `/\d+/`（单反斜杠）。
  - 为 `OrthographicCamera` 添加 `near={0.1}` 和 `far={200}` 参数，稳定视锥体。
  - 在 `Mountain` 组件中使用 `useMemo` 包裹随机生成逻辑，仅在位置变化时重新生成，避免每帧闪烁。

### 近场状态管理
- 近场检测在每帧（`useFrame`）中持续运行，但在 `inputFocused` 为 true 时跳过，避免输入期间误触发。
- 在 `THINKING/ACTING/ASKING` 状态下，近场检测不会自动切换状态（保持任务执行不被打断）。
- 任务结束时，主动检测玩家-NPC 距离并设置正确状态。

### 对话系统架构（v1.3 - 2025-12-09）

**设计理念**：分离对话与系统日志，提供清晰的交互体验。

#### 双轨日志系统
1. **对话框（底部居中）**：
   - 专注于玩家-NPC 的交流历史
   - 仅显示 `type === 'chat'` 的消息
   - 非聚焦：显示最近 3 条对话
   - 聚焦：显示最近 5 条对话，支持滚轮查看更多历史
   - 完全手动控制滚动，不自动滚到底部

2. **日志窗口（右上角）**：
   - 记录所有游戏事件（对话 + 系统消息）
   - 显示所有类型的日志（`chat` 和 `system`）
   - 收起状态：显示最近 3 条系统消息
   - 展开状态：可滚动查看完整日志历史

#### 消息流向
```
玩家输入 → handleSend → 
  1. addLog('{leaderName}: {text}', 'chat')  // 立即显示
  2. setPendingCommand(text)                  // 触发游戏逻辑
  
NPC/系统响应 → addLog(text, 'chat'/'system') → 
  - chat: 显示在对话框 + 日志窗口
  - system: 仅显示在日志窗口
```

#### 关键实现
- 使用 `useMemo` 过滤 `chatLogs = logs.filter(l => l.type === 'chat')`
- 根据 `inputFocused` 状态动态计算显示数量：`chatLogs.slice(-(inputFocused ? 5 : 3))`
- 玩家消息在 `handleSend` 中**立即**记录，避免等待游戏逻辑处理
- 系统消息（如"德米特里砍伐了树木，木材 +1"）只在日志窗口显示，不打断对话流

#### 用户体验目标
- 对话框呈现沉浸式的对话历史，类似聊天应用
- 日志窗口作为全局事件追踪器，方便查看游戏进度
- 避免系统消息干扰玩家与 NPC 的交流节奏

### NPC 回复真实感优化（v1.4 - 2025-12-09）

**设计目标**：模拟真实对话节奏，避免 NPC 瞬间回复多条消息。

#### 随机延迟机制
- 引入 `getRandomDelay(min, max)` 函数，为每条 NPC 回复生成随机延迟
- 不同场景的延迟范围：
  - 不支持的指令回复：1000-1800ms
  - 询问数量：800-1400ms
  - 没听清数量：700-1300ms
  - 确认数量：800-1400ms
  - NPC 开始行动：在确认回复后额外等待 500-800ms

#### 时序控制
```
玩家发送消息 → [立即显示]
  ↓ [随机延迟 800-1800ms]
NPC 回复 → [显示]
  ↓ [额外延迟 500-800ms]
NPC 开始行动 → [ACTING 状态]
```

#### 关键实现
- 移除游戏逻辑中的重复玩家消息记录（已在 UI 层处理）
- 每条 NPC 回复都有独立的随机延迟
- 多句回复之间通过延迟时序自然分隔
- 行动开始时间基于最后一条回复的延迟计算，确保"说完再做"

## 维护指引
- 新功能或改动时务必同步更新本文件（新增模块、数据流、交互变更、测试策略变更）。
- 先更新文档，再补/改测试并运行 `npm test`，全部通过后再视为完成开发。
- Bug 修复应记录在"关键实现细节"相关章节，注明日期与问题描述。

